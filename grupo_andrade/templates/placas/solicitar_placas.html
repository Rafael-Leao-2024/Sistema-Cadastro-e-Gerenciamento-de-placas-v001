{% extends "layout.html" %}

{% block title %}Solicitar Placas{% endblock %}

{% block content %}
<div class="animate-fadeIn">
  <!-- Header Estilizado -->
  <div class="relative mb-8 sm:mb-12">
    <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 rounded-2xl blur-xl"></div>
    <div class="relative glass-effect-advanced rounded-2xl border border-cyan-500/20 p-6 sm:p-8">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center shadow-lg shadow-cyan-500/25">
            <i class="fas fa-plus-circle text-white text-lg sm:text-xl"></i>
          </div>
          <div>
            <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">
              Nova Solicitação
            </h2>
            <p class="text-cyan-300/70 text-sm sm:text-base mt-1">Preencha os dados da sua placa</p>
          </div>
        </div>
        <a href="{{ url_for('placas.minhas_placas') }}" class="futuristic-nav-btn px-4 sm:px-6 py-2.5 sm:py-3 group w-full sm:w-auto text-center">
          <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform duration-200"></i>
          Voltar
        </a>
      </div>
    </div>
  </div>

  <!-- Grid Principal -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
    <!-- Coluna Esquerda - Informações do Usuário -->
    <div class="lg:col-span-1">
      <div class="glass-effect-advanced rounded-2xl border border-cyan-500/20 overflow-hidden h-full">
        <div class="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 border-b border-cyan-500/20 px-6 py-4">
          <h3 class="text-lg font-semibold text-cyan-100 flex items-center">
            <i class="fas fa-user-circle mr-3 text-cyan-400"></i>
            Seus Dados
          </h3>
        </div>
        <div class="p-6">
          <div class="space-y-6">
            <!-- Avatar e Nome -->
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center">
                <i class="fas fa-user text-white"></i>
              </div>
              <div>
                <h4 class="font-bold text-cyan-100">{{ current_user.username }}</h4>
                <p class="text-sm text-cyan-300/70">{{ current_user.email }}</p>
              </div>
            </div>

            <!-- Informações Detalhadas -->
            <div class="space-y-4">
              <div class="p-4 rounded-xl bg-slate-800/30 border border-cyan-500/10">
                <div class="flex items-center text-cyan-300 mb-2">
                  <i class="fas fa-map-marker-alt mr-2 text-cyan-400"></i>
                  <span class="text-sm font-medium">Endereço para Entrega</span>
                </div>
                <p class="text-cyan-100 text-sm">{{ endereco }}</p>
              </div>

              <div class="p-4 rounded-xl bg-slate-800/30 border border-cyan-500/10">
                <div class="flex items-center text-cyan-300 mb-2">
                  <i class="fas fa-user-tie mr-2 text-cyan-400"></i>
                  <span class="text-sm font-medium">Despachante</span>
                </div>
                <p class="text-cyan-100 text-sm">{{ despachante }}</p>
              </div>
            </div>

            <!-- Status Info -->
            <div class="p-4 rounded-xl bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/20">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-cyan-300">Status da Conta</span>
                <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400 border border-green-500/30">
                  Ativa
                </span>
              </div>
              <p class="text-xs text-cyan-300/70">Todos os dados estão prontos para envio.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Coluna Direita - Formulário -->
    <div class="lg:col-span-2">
      <form method="POST" id="solicitarForm" class="space-y-6 sm:space-y-8">
        <!-- Card do Formulário -->
        <div class="glass-effect-advanced rounded-2xl border border-cyan-500/20 overflow-hidden">
          <div class="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 border-b border-cyan-500/20 px-6 py-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center mr-3">
                  <i class="fas fa-car text-white"></i>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-cyan-100">Dados da Placa</h3>
                  <p class="text-sm text-cyan-300/70">Preencha as informações do veículo</p>
                </div>
              </div>
              <button type="button" id="add-placa" class="futuristic-btn-sm group px-4 py-2.5">
                <i class="fas fa-plus mr-2 group-hover:scale-110 transition-transform duration-200"></i>
                Adicionar Placa
              </button>
            </div>
          </div>

          <!-- Container das Placas -->
          <div class="p-6" id="placas-container">
            <!-- Primeira Placa -->
            <div class="placa-item group relative p-6 rounded-xl bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-cyan-500/20 hover:border-cyan-400/30 transition-all duration-300">
              <!-- Header da Placa -->
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                  <div class="w-8 h-8 rounded-lg bg-cyan-500/10 border border-cyan-500/20 flex items-center justify-center mr-3">
                    <i class="fas fa-car text-cyan-400 text-sm"></i>
                  </div>
                  <span class="text-sm font-semibold text-cyan-300">Placa #<span class="placa-counter text-cyan-100">1</span></span>
                </div>
                <button type="button" class="remove-placa-btn opacity-0 group-hover:opacity-100 transition-all duration-200 text-red-400 hover:text-red-300">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>

              <!-- Grid de Campos -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Chassi -->
                <div class="form-group">
                  <label class="block text-sm font-medium text-cyan-300 mb-2 flex items-center">
                    <i class="fas fa-barcode mr-2 text-cyan-400"></i>
                    Chassi
                  </label>
                  <input
                    type="text"
                    name="chassi"
                    class="futuristic-input"
                    value="{{ chassi }}"
                    placeholder="Digite o número do chassi"
                    required
                  />
                </div>

                <!-- Placa -->
                <div class="form-group">
                  <label class="block text-sm font-medium text-cyan-300 mb-2 flex items-center">
                    <i class="fas fa-car-alt mr-2 text-cyan-400"></i>
                    Placa
                  </label>
                  <input
                    type="text"
                    name="placa"
                    class="futuristic-input uppercase"
                    value="{{ placa }}"
                    placeholder="Ex: ABC1B34"
                    required
                  />
                </div>

                <!-- Renavam -->
                <div class="form-group">
                  <label class="block text-sm font-medium text-cyan-300 mb-2 flex items-center">
                    <i class="fas fa-hashtag mr-2 text-cyan-400"></i>
                    Renavam
                  </label>
                  <input 
                    type="text" 
                    name="renavam" 
                    class="futuristic-input"
                    value="00000000000"
                    placeholder="11 dígitos"
                  />
                </div>

                <!-- CRLV -->
                <div class="form-group">
                  <label class="block text-sm font-medium text-cyan-300 mb-2 flex items-center">
                    <i class="fas fa-file-alt mr-2 text-cyan-400"></i>
                    CRLV
                  </label>
                  <input 
                    type="text" 
                    name="crlv" 
                    class="futuristic-input" 
                    value="000000000" 
                    placeholder="9 dígitos"
                  />
                </div>

                <!-- Endereço -->
                <div class="form-group md:col-span-2">
                  <label class="block text-sm font-medium text-cyan-300 mb-2 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-cyan-400"></i>
                    Endereço de Entrega (opcional)
                  </label>
                  <input
                    type="text"
                    name="endereco_placa"
                    class="futuristic-input"
                    {% if current_user.enderecos and current_user.enderecos|length > 0 %}
                    value="{{ current_user.enderecos[-1].rua }}"
                    {% else %}
                    value=""
                    {% endif %}
                    placeholder="Digite o endereço para entrega"
                  />
                </div>

                <!-- Honorário -->
                <div class="form-group">
                  <label class="block text-sm font-medium text-cyan-300 mb-2 flex items-center">
                    <i class="fas fa-dollar-sign mr-2 text-cyan-400"></i>
                    Valor do Honorário R$
                  </label>
                  <div class="relative">
                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-cyan-400"></span>
                    <input
                      type="number"
                      name="honorario"
                      value="{{ placa.honorario if placa.honorario else '' }}"
                      class="futuristic-input pl-12"
                      placeholder="1,99"
                      step="0.01"
                      min="0"
                      required
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumo e Envio -->
        <div class="glass-effect-advanced rounded-2xl border border-cyan-500/20 p-6">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
            <!-- Resumo -->
            <div class="flex-1">
              <h4 class="text-lg font-semibold text-cyan-100 mb-4">Resumo da Solicitação</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-4 rounded-xl bg-slate-800/30 border border-cyan-500/10">
                  <div class="flex items-center mb-2">
                    <div class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center mr-3">
                      <i class="fas fa-car text-cyan-400"></i>
                    </div>
                    <div>
                      <p class="text-sm text-cyan-300">Total de Placas</p>
                      <p class="text-2xl font-bold text-cyan-100" id="total-placas">1</p>
                    </div>
                  </div>
                </div>

                <div class="p-4 rounded-xl bg-slate-800/30 border border-cyan-500/10">
                  <div class="flex items-center mb-2">
                    <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center mr-3">
                      <i class="fas fa-dollar-sign text-green-400"></i>
                    </div>
                    <div>
                      <p class="text-sm text-cyan-300">Valor Total</p>
                      <p class="text-2xl font-bold text-green-100">R$ <span id="total-honorarios">{{ current_user.calcular_honorarios() }}</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botão Enviar -->
            <div class="lg:text-right">
              <button type="submit" class="futuristic-btn px-8 py-4 group relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-cyan-500 to-blue-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <div class="relative flex items-center justify-center">
                  <i class="fas fa-paper-plane mr-3 group-hover:translate-x-1 transition-transform duration-200"></i>
                  <span class="font-semibold">Enviar Solicitação</span>
                </div>
              </button>
              <p class="text-xs text-cyan-300/70 mt-3 max-w-xs">
                <i class="fas fa-info-circle mr-1"></i>
                Sua solicitação será processada em até 24h
              </p>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div id="confirmModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 hidden">
  <div class="glass-effect-advanced rounded-2xl border border-cyan-500/20 max-w-md w-full animate-fadeIn transform transition-all duration-300">
    <div class="p-6">
      <div class="w-16 h-16 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-paper-plane text-white text-xl"></i>
      </div>
      <h3 class="text-xl font-bold text-cyan-100 text-center mb-2">Confirmar Envio</h3>
      <p class="text-cyan-300 text-center mb-6">
        Deseja enviar <span class="font-semibold text-cyan-100" id="modal-placas-count">1</span> 
        solicitação(ões) no valor total de 
        <span class="font-semibold text-green-400">R$ <span id="modal-total-value">0.00</span></span>?
      </p>
      <div class="flex gap-3">
        <button type="button" id="confirmCancel" class="futuristic-nav-btn flex-1 py-3">
          Cancelar
        </button>
        <button type="button" id="confirmSubmit" class="futuristic-btn flex-1 py-3">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Variáveis
    let placaCount = 1;
    const totalPlacasElement = document.getElementById('total-placas');
    const totalHonorariosElement = document.getElementById('total-honorarios');
    const container = document.getElementById('placas-container');
    const addButton = document.getElementById('add-placa');
    const form = document.getElementById('solicitarForm');

    // Atualizar totais
    function updateTotals() {
      const placas = document.querySelectorAll('.placa-item');
      totalPlacasElement.textContent = placas.length;
      
      let total = 0;
      placas.forEach(placa => {
        const honorarioInput = placa.querySelector('input[name="honorario"]');
        total += parseFloat(honarioInput.value || 0);
      });
      
      totalHonorariosElement.textContent = total.toFixed(2).replace('.', ',');
    }

    // Formatar entrada para maiúsculas
    document.querySelectorAll('.uppercase').forEach(input => {
      input.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    });

    // Adicionar nova placa
    if (addButton && container) {
      addButton.addEventListener('click', function() {
        const placaItems = document.querySelectorAll('.placa-item');
        if (placaItems.length >= 5) {
          showToast('Máximo de 5 solicitações por vez', 'warning');
          return;
        }
        
        const template = placaItems[0].cloneNode(true);
        placaCount++;
        
        // Atualizar contador
        const counter = template.querySelector('.placa-counter');
        if (counter) counter.textContent = placaCount;
        
        // Limpar valores
        template.querySelectorAll('input').forEach(input => {
          input.value = '';
          if (input.name === 'honorario') input.value = '0';
          if (input.name === 'renavam') input.value = '00000000000';
          if (input.name === 'crlv') input.value = '000000000';
        });
        
        // Mostrar botão de remover
        const removeBtn = template.querySelector('.remove-placa-btn');
        removeBtn.classList.remove('opacity-0');
        
        // Adicionar à lista
        container.appendChild(template);
        
        // Adicionar evento de remoção
        addRemoveEvent(template);
        
        // Atualizar totais
        updateTotals();
        
        // Animar entrada
        template.style.opacity = '0';
        template.style.transform = 'translateY(20px)';
        setTimeout(() => {
          template.style.opacity = '1';
          template.style.transform = 'translateY(0)';
          template.style.transition = 'all 0.3s ease';
        }, 10);
        
        showToast('Nova placa adicionada', 'success');
      });
    }

    // Função para remover placa
    function addRemoveEvent(element) {
      const removeBtn = element.querySelector('.remove-placa-btn');
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          const allPlacas = document.querySelectorAll('.placa-item');
          if (allPlacas.length > 1) {
            // Animar saída
            element.style.opacity = '0';
            element.style.transform = 'translateX(20px)';
            
            setTimeout(() => {
              element.remove();
              updateTotals();
              updateCounters();
              showToast('Placa removida', 'info');
            }, 300);
          } else {
            showToast('Você precisa ter pelo menos uma placa', 'warning');
          }
        });
      }
      
      // Atualizar totais quando honorário muda
      const honorarioInput = element.querySelector('input[name="honorario"]');
      if (honorarioInput) {
        honorarioInput.addEventListener('input', updateTotals);
      }
    }

    // Atualizar contadores
    function updateCounters() {
      const placas = document.querySelectorAll('.placa-item');
      placas.forEach((placa, index) => {
        const counter = placa.querySelector('.placa-counter');
        if (counter) counter.textContent = index + 1;
      });
      placaCount = placas.length;
    }

    // Setup inicial
    document.querySelectorAll('.placa-item').forEach((item, index) => {
      if (index > 0) {
        const removeBtn = item.querySelector('.remove-placa-btn');
        if (removeBtn) removeBtn.classList.remove('opacity-0');
        addRemoveEvent(item);
      }
      
      const honorarioInput = item.querySelector('input[name="honorario"]');
      if (honorarioInput) {
        honorarioInput.addEventListener('input', updateTotals);
      }
    });
    
    updateTotals();
    
    // Validação do formulário
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validar campos obrigatórios
        let isValid = true;
        const placas = document.querySelectorAll('.placa-item');
        
        placas.forEach(placa => {
          const chassi = placa.querySelector('input[name="chassi"]');
          const placaNum = placa.querySelector('input[name="placa"]');
          const honorario = placa.querySelector('input[name="honorario"]');
          
          if (!chassi.value.trim() || !placaNum.value.trim() || !honorario.value.trim()) {
            isValid = false;
            [chassi, placaNum, honorario].forEach(input => {
              if (!input.value.trim()) {
                input.classList.add('error');
              }
            });
          }
        });
        
        if (!isValid) {
          showToast('Preencha todos os campos obrigatórios', 'error');
          return;
        }
        
        // Mostrar modal de confirmação em mobile
        if (window.innerWidth < 768) {
          showConfirmationModal();
        } else {
          // Enviar diretamente em desktop
          this.submit();
        }
      });
    }
    
    // Remover erro ao digitar
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', function() {
        this.classList.remove('error');
      });
    });
    
    // Modal de confirmação
    const confirmModal = document.getElementById('confirmModal');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmSubmit = document.getElementById('confirmSubmit');
    
    function showConfirmationModal() {
      document.getElementById('modal-placas-count').textContent = totalPlacasElement.textContent;
      document.getElementById('modal-total-value').textContent = totalHonorariosElement.textContent;
      confirmModal.classList.remove('hidden');
    }
    
    if (confirmCancel) {
      confirmCancel.addEventListener('click', function() {
        confirmModal.classList.add('hidden');
      });
    }
    
    if (confirmSubmit) {
      confirmSubmit.addEventListener('click', function() {
        confirmModal.classList.add('hidden');
        form.submit();
      });
    }
    
    // Fechar modal ao clicar fora
    confirmModal.addEventListener('click', function(e) {
      if (e.target === confirmModal) {
        confirmModal.classList.add('hidden');
      }
    });
    
    // Toast notifications
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-xl glass-effect-advanced border ${
        type === 'success' ? 'border-green-500/20 text-green-300' :
        type === 'warning' ? 'border-yellow-500/20 text-yellow-300' :
        type === 'error' ? 'border-red-500/20 text-red-300' :
        'border-cyan-500/20 text-cyan-300'
      } transform translate-x-full transition-transform duration-300`;
      toast.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times-circle' : 'info-circle'} mr-3"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.remove('translate-x-full'), 100);
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  });
</script>

<style>
  .futuristic-input {
    width: 100%;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 0.75rem;
    padding: 0.875rem 1rem;
    color: #f1f5f9;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
  }
  
  .futuristic-input:focus {
    outline: none;
    border-color: rgba(6, 182, 212, 0.5);
    box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
  }
  
  .futuristic-input::placeholder {
    color: rgba(148, 163, 184, 0.5);
  }
  
  .futuristic-input.error {
    border-color: rgba(239, 68, 68, 0.5);
    animation: shake 0.3s ease-in-out;
  }
  
  .futuristic-btn {
    background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
    color: white;
    padding: 0.875rem 2rem;
    border-radius: 0.75rem;
    font-weight: 500;
    border: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }
  
  .futuristic-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.4);
  }
  
  .futuristic-btn-sm {
    background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
    color: white;
    padding: 0.625rem 1.25rem;
    border-radius: 0.625rem;
    font-weight: 500;
    border: none;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .futuristic-btn-sm:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
  }
  
  .futuristic-nav-btn {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    color: #cbd5e1;
    border-radius: 0.625rem;
    padding: 0.625rem 1.25rem;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .futuristic-nav-btn:hover {
    border-color: rgba(6, 182, 212, 0.4);
    color: white;
    transform: translateY(-1px);
  }
  
  .glass-effect-advanced {
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
  }
  
  /* Responsividade */
  @media (max-width: 640px) {
    .futuristic-input {
      padding: 0.75rem;
      font-size: 0.875rem;
    }
    
    .futuristic-btn {
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
    }
    
    .glass-effect-advanced {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
  }
  
  /* Efeitos de hover nas placas */
  .placa-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.1);
  }
  
  .placa-item {
    transition: all 0.3s ease;
  }
</style>
{% endblock %}