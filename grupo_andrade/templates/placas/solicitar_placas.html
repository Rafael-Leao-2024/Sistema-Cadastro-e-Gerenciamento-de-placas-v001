{% extends "layout.html" %}
{% block title %}Nova Solicitação{% endblock %}

{% block content %}
<div class="min-h-[70vh] py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <!-- Cabeçalho -->
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                <div>
                    <h1 class="text-xl font-semibold text-gray-100 mb-1">Nova Solicitação</h1>
                    <p class="text-gray-400 text-sm">Adicionar nova placa</p>
                </div>
                <div class="flex gap-2">
                    <a href="{{ url_for('placas.minhas_placas') }}" 
                       class="px-3 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                        Voltar
                    </a>
                </div>
            </div>
        </div>

        <!-- Layout principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Informações do usuário -->
            <div class="lg:col-span-1">
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 mb-4 lg:mb-0">
                    <h3 class="text-sm font-medium text-gray-300 mb-4">Seus dados</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center mr-3">
                                <span class="text-gray-300">{{ current_user.username|first|upper }}</span>
                            </div>
                            <div>
                                <div class="text-gray-100 text-sm">{{ current_user.username }}</div>
                                <div class="text-gray-500 text-xs">{{ current_user.email }}</div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="text-gray-500 text-xs">Endereço</div>
                            <div class="text-gray-300 text-sm">{{ endereco }}</div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="text-gray-500 text-xs">Despachante</div>
                            <div class="text-gray-300 text-sm">{{ despachante }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulário -->
            <div class="lg:col-span-2">
                <form method="POST" class="space-y-6">
                    <!-- Card do formulário -->
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-medium text-gray-300">Dados da placa</h3>
                            <button type="button" 
                                    id="add-placa"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs">
                                + Adicionar outra
                            </button>
                        </div>
                        
                        <!-- Container das placas -->
                        <div id="placas-container" class="space-y-4">
                            <!-- Primeira placa -->
                            <div class="placa-item bg-gray-900/50 rounded border border-gray-700 p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="text-gray-400 text-sm">Placa #<span class="placa-counter text-gray-300">1</span></div>
                                    <!-- Botão de remover escondido para a primeira placa -->
                                    <button type="button" 
                                            class="remove-placa-btn text-gray-500 hover:text-red-400 transition-colors text-sm hidden">
                                        × Remover
                                    </button>
                                </div>
                                
                                <div class="space-y-4">
                                    <!-- Chassi -->
                                    <div>
                                        <label class="block text-gray-400 text-xs mb-2">Chassi</label>
                                        <input type="text" 
                                               name="chassi" 
                                               class="w-full px-3 py-2 bg-gray-800 text-gray-100 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-sm"
                                               value="{{ chassi }}"
                                               placeholder="Número do chassi"
                                               required>
                                    </div>
                                    
                                    <!-- Placa -->
                                    <div>
                                        <label class="block text-gray-400 text-xs mb-2">Placa</label>
                                        <input type="text" 
                                               name="placa" 
                                               class="w-full px-3 py-2 bg-gray-800 text-gray-100 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-sm uppercase"
                                               value="{{ placa }}"
                                               placeholder="Ex: ABC1B34"
                                               required>
                                    </div>
                                    
                                    <!-- Renavam e CRLV -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-2">Renavam</label>
                                            <input type="text" 
                                                   name="renavam" 
                                                   class="w-full px-3 py-2 bg-gray-800 text-gray-100 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-sm"
                                                   value="00000000000"
                                                   placeholder="11 dígitos">
                                        </div>
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-2">CRLV</label>
                                            <input type="text" 
                                                   name="crlv" 
                                                   class="w-full px-3 py-2 bg-gray-800 text-gray-100 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-sm"
                                                   value="000000000"
                                                   placeholder="9 dígitos">
                                        </div>
                                    </div>
                                    
                                    <!-- Endereço -->
                                    <div>
                                        <label class="block text-gray-400 text-xs mb-2">Endereço de entrega (opcional)</label>
                                        <input type="text" 
                                               name="endereco_placa" 
                                               class="w-full px-3 py-2 bg-gray-800 text-gray-100 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-sm"
                                               {% if current_user.enderecos and current_user.enderecos|length > 0 %}
                                               value="{{ current_user.enderecos[-1].rua }}"
                                               {% endif %}
                                               placeholder="Endereço para entrega">
                                    </div>
                                    
                                    <!-- Honorário -->
                                    <div>
                                        <label class="block text-gray-400 text-xs mb-2">Valor do honorário (R$)</label>
                                        <input type="number" 
                                               name="honorario" 
                                               class="w-full px-3 py-2 bg-gray-800 text-gray-100 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-sm"
                                               value="{{ placa.honorario if placa.honorario else '0.00' }}"
                                               placeholder="0.00"
                                               step="0.01"
                                               min="0"
                                               required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumo e envio -->
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                        <div class="space-y-4">
                            <h3 class="text-sm font-medium text-gray-300">Resumo</h3>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-900/50 rounded p-3">
                                    <div class="text-gray-400 text-xs mb-1">Total de placas</div>
                                    <div class="text-gray-100 text-lg" id="total-placas">1</div>
                                </div>
                                
                                <div class="bg-gray-900/50 rounded p-3">
                                    <div class="text-gray-400 text-xs mb-1">Valor total</div>
                                    <div class="text-green-400 text-lg" id="total-honorarios">
                                        R$ {{ "%.2f"|format(current_user.calcular_honorarios()) }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-4 border-t border-gray-700">
                                <button type="submit" 
                                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
                                    Enviar solicitação
                                </button>
                                <p class="text-gray-500 text-xs text-center mt-2">
                                    Processamento em até 24h
                                </p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Animações */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .placa-item {
        animation: fadeIn 0.3s ease-out;
    }
    
    /* Responsividade */
    @media (max-width: 1024px) {
        .lg\:grid-cols-3 {
            grid-template-columns: 1fr;
        }
    }
    
    /* Auto uppercase */
    .uppercase {
        text-transform: uppercase;
    }
    
    /* Botão de remover */
    .remove-placa-btn {
        cursor: pointer;
        background: none;
        border: none;
        padding: 4px 8px;
        font-size: 12px;
    }
    
    .remove-placa-btn:hover {
        background-color: rgba(239, 68, 68, 0.1);
        border-radius: 4px;
    }
    
    .hidden {
        display: none;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let placaCount = 1;
        const container = document.getElementById('placas-container');
        const addButton = document.getElementById('add-placa');
        const totalPlacasElement = document.getElementById('total-placas');
        
        // Auto uppercase para campo placa
        document.querySelectorAll('.uppercase').forEach(input => {
            input.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        });
        
        // Formatar valor monetário
        document.querySelectorAll('input[name="honorario"]').forEach(input => {
            input.addEventListener('blur', function() {
                let value = this.value.replace(',', '.');
                if (value && !isNaN(value)) {
                    const num = parseFloat(value);
                    this.value = num.toFixed(2);
                    updateTotalHonorarios();
                }
            });
        });
        
        // Adicionar nova placa
        if (addButton && container) {
            addButton.addEventListener('click', function() {
                const placas = document.querySelectorAll('.placa-item');
                if (placas.length >= 5) {
                    alert('Máximo de 5 solicitações por vez');
                    return;
                }
                
                // Clonar primeira placa
                const template = placas[0].cloneNode(true);
                placaCount++;
                
                // Atualizar contador
                const counter = template.querySelector('.placa-counter');
                if (counter) counter.textContent = placaCount;
                
                // Limpar valores
                template.querySelectorAll('input').forEach(input => {
                    input.value = '';
                    if (input.name === 'honorario') input.value = '0.00';
                    if (input.name === 'renavam') input.value = '00000000000';
                    if (input.name === 'crlv') input.value = '000000000';
                });
                
                // Mostrar botão de remover
                const removeBtn = template.querySelector('.remove-placa-btn');
                if (removeBtn) {
                    removeBtn.classList.remove('hidden');
                }
                
                // Adicionar à lista
                container.appendChild(template);
                
                // Adicionar eventos
                addPlacaEvents(template);
                
                // Atualizar contador
                updateTotalPlacas();
                
                // Scroll para nova placa
                template.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });
        }
        
        // Adicionar eventos a uma placa
        function addPlacaEvents(placaItem) {
            // Botão remover
            const removeBtn = placaItem.querySelector('.remove-placa-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    const allPlacas = document.querySelectorAll('.placa-item');
                    if (allPlacas.length > 1) {
                        placaItem.remove();
                        updateTotalPlacas();
                        updateCounters();
                        updateTotalHonorarios();
                    }
                });
            }
            
            // Formatar honorário
            const honorarioInput = placaItem.querySelector('input[name="honorario"]');
            if (honorarioInput) {
                honorarioInput.addEventListener('blur', updateTotalHonorarios);
            }
            
            // Auto uppercase para placa
            const placaInput = placaItem.querySelector('.uppercase');
            if (placaInput) {
                placaInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
        }
        
        // Atualizar contador de placas
        function updateTotalPlacas() {
            const placas = document.querySelectorAll('.placa-item');
            totalPlacasElement.textContent = placas.length;
            
            // Atualizar texto do botão adicionar
            const addBtn = document.getElementById('add-placa');
            if (addBtn) {
                if (placas.length >= 5) {
                    addBtn.textContent = 'Máximo alcançado';
                    addBtn.disabled = true;
                    addBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    addBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
                } else {
                    addBtn.textContent = '+ Adicionar outra';
                    addBtn.disabled = false;
                    addBtn.classList.remove('bg-gray-600', 'cursor-not-allowed');
                    addBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            }
        }
        
        // Atualizar total de honorários
        function updateTotalHonorarios() {
            let total = 0;
            document.querySelectorAll('input[name="honorario"]').forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            const totalElement = document.getElementById('total-honorarios');
            if (totalElement) {
                totalElement.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
            }
        }
        
        // Atualizar números das placas
        function updateCounters() {
            const placas = document.querySelectorAll('.placa-item');
            placas.forEach((placa, index) => {
                const counter = placa.querySelector('.placa-counter');
                if (counter) counter.textContent = index + 1;
                
                // Mostrar/ocultar botão de remover
                const removeBtn = placa.querySelector('.remove-placa-btn');
                if (removeBtn) {
                    if (index === 0) {
                        removeBtn.classList.add('hidden');
                    } else {
                        removeBtn.classList.remove('hidden');
                    }
                }
            });
        }
        
        // Adicionar eventos à primeira placa
        const primeiraPlaca = document.querySelector('.placa-item');
        if (primeiraPlaca) {
            addPlacaEvents(primeiraPlaca);
        }
        
        // Validar formulário
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                let isValid = true;
                const errors = [];
                
                document.querySelectorAll('.placa-item').forEach((placa, index) => {
                    const chassi = placa.querySelector('input[name="chassi"]');
                    const placaNum = placa.querySelector('input[name="placa"]');
                    const honorario = placa.querySelector('input[name="honorario"]');
                    
                    if (!chassi.value.trim()) {
                        errors.push(`Placa ${index + 1}: Chassi é obrigatório`);
                        chassi.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    if (!placaNum.value.trim()) {
                        errors.push(`Placa ${index + 1}: Número da placa é obrigatório`);
                        placaNum.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    const honorarioVal = parseFloat(honorario.value);
                    if (!honorarioVal || honorarioVal <= 0) {
                        errors.push(`Placa ${index + 1}: Valor do honorário deve ser maior que zero`);
                        honorario.classList.add('border-red-500');
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Corrija os seguintes erros:\n\n' + errors.join('\n'));
                }
            });
        }
        
        // Remover borda vermelha ao digitar
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('border-red-500');
            });
        });
        
        // Inicializar
        updateTotalHonorarios();
    });
</script>

{% endblock %}