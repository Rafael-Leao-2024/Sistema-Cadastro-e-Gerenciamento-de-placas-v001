{% extends "layout.html" %}
{% block content %}

<div class="min-h-screen bg-gray-100 p-4">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
          <i class="fas fa-file-upload text-blue-600 text-xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Adicionar Documentos</h1>
        <div class="flex items-center justify-center gap-2 mb-3">
          <span class="text-gray-600">Placa:</span>
          <a href="{{ url_for('placas.placa_detail', placa_id=placa.id) }}" 
             class="font-mono text-blue-600 font-medium bg-blue-50 px-3 py-1 rounded">
            {{ placa.placa }}
          </a>
        </div>
        <p class="text-gray-500 text-sm">Adicione documentos em PDF para esta placa</p>
      </div>
    </div>

    <!-- Upload Form -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="bg-gray-50 px-6 py-4 border-b">
        <h2 class="text-lg font-semibold text-gray-800">
          <i class="fas fa-upload mr-2 text-blue-600"></i>
          Selecione os Arquivos
        </h2>
      </div>

      <form method="POST" enctype="multipart/form-data" class="p-6" id="uploadForm">
        <!-- File Upload Area -->
        <div class="mb-6">
          <label class="block text-gray-700 font-medium mb-3">
            <i class="fas fa-file-pdf mr-2 text-red-500"></i>
            Selecione arquivos PDF
          </label>
          
          <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-8 hover:border-blue-400 transition-colors">
            <input
              type="file"
              name="file"
              accept=".pdf"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
              multiple
              required
              id="fileInput"
            />
            <div class="text-center space-y-3">
              <div class="w-12 h-12 mx-auto rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fas fa-file-pdf text-blue-500 text-xl"></i>
              </div>
              <div>
                <p class="text-gray-800 font-medium" id="uploadText">Clique para selecionar arquivos</p>
                <p class="text-gray-500 text-sm mt-1">ou arraste e solte aqui</p>
              </div>
              <p class="text-gray-400 text-xs">
                Apenas arquivos .pdf • Máximo 10 arquivos
              </p>
            </div>
          </div>
          
          <!-- Progress Container (hidden by default) -->
          <div id="progressContainer" class="mt-4 hidden">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-600">Enviando arquivos...</span>
              <span id="progressPercent" class="text-sm font-medium text-blue-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- Selected Files List -->
          <div id="selectedFiles" class="mt-4 space-y-2 hidden"></div>
        </div>

        <!-- Submit Button -->
        <button type="submit"
                class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center"
                id="submitBtn">
          <i class="fas fa-cloud-upload-alt mr-2"></i>
          <span id="btnText">Enviar Documentos</span>
          <div id="loadingSpinner" class="hidden ml-2">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
          </div>
        </button>
      </form>
    </div>

    <!-- View Documents Button -->
    <div class="text-center mb-6">
      <a href="{{ url_for('documentos.download_anexos', id_placa=placa.id) }}"
         class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">
        <i class="fas fa-download mr-2"></i>
        Ver Documentos Existentes
      </a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="space-y-3 mb-6">
        {% for category, message in messages %}
        <div class="{% if category == 'success' %}bg-green-50 border-green-200 text-green-700{% else %}bg-red-50 border-red-200 text-red-700{% endif %} border rounded-lg p-4">
          <div class="flex items-center justify-center">
            {% if category == 'success' %}
            <i class="fas fa-check-circle mr-2"></i>
            {% else %}
            <i class="fas fa-exclamation-circle mr-2"></i>
            {% endif %}
            <span>{{ message }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    {% endwith %}

    <!-- Info Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="bg-white rounded-lg shadow-sm p-4 text-center border">
        <div class="w-10 h-10 mx-auto mb-2 rounded-full bg-green-100 flex items-center justify-center">
          <i class="fas fa-file-pdf text-green-600"></i>
        </div>
        <p class="text-gray-800 font-medium text-sm">Somente PDF</p>
        <p class="text-gray-500 text-xs">Apenas arquivos .pdf</p>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-4 text-center border">
        <div class="w-10 h-10 mx-auto mb-2 rounded-full bg-blue-100 flex items-center justify-center">
          <i class="fas fa-copy text-blue-600"></i>
        </div>
        <p class="text-gray-800 font-medium text-sm">Múltiplos</p>
        <p class="text-gray-500 text-xs">Vários de uma vez</p>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-4 text-center border">
        <div class="w-10 h-10 mx-auto mb-2 rounded-full bg-purple-100 flex items-center justify-center">
          <i class="fas fa-sync text-purple-600"></i>
        </div>
        <p class="text-gray-800 font-medium text-sm">Upload em Lote</p>
        <p class="text-gray-500 text-xs">Todos juntos</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('uploadForm');
  const fileInput = document.getElementById('fileInput');
  const uploadText = document.getElementById('uploadText');
  const submitBtn = document.getElementById('submitBtn');
  const btnText = document.getElementById('btnText');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  const selectedFiles = document.getElementById('selectedFiles');

  // Show selected files
  fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
      uploadText.textContent = `${this.files.length} arquivo(s) selecionado(s)`;
      selectedFiles.innerHTML = '';
      selectedFiles.classList.remove('hidden');
      
      for (let i = 0; i < this.files.length; i++) {
        const file = this.files[i];
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded';
        fileItem.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-file-pdf text-red-500 mr-3"></i>
            <div>
              <p class="text-sm text-gray-800 truncate max-w-[200px]">${file.name}</p>
              <p class="text-xs text-gray-500">${fileSize} MB</p>
            </div>
          </div>
        `;
        selectedFiles.appendChild(fileItem);
      }
    } else {
      uploadText.textContent = 'Clique para selecionar arquivos';
      selectedFiles.classList.add('hidden');
    }
  });

  // Form submission with progress simulation
  form.addEventListener('submit', function(e) {
    if (fileInput.files.length === 0) {
      e.preventDefault();
      return;
    }

    // Show loading state
    submitBtn.disabled = true;
    btnText.textContent = 'Enviando...';
    loadingSpinner.classList.remove('hidden');
    progressContainer.classList.remove('hidden');

    // Simulate progress (in real app this would come from actual upload progress)
    let progress = 0;
    const interval = setInterval(() => {
      progress += 10;
      if (progress <= 100) {
        progressBar.style.width = `${progress}%`;
        progressPercent.textContent = `${progress}%`;
        
        // Slow down as we approach 90%
        if (progress >= 90) {
          clearInterval(interval);
          // At 90%, wait for actual upload to complete
          setTimeout(() => {
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            btnText.textContent = 'Processando...';
          }, 1000);
        }
      } else {
        clearInterval(interval);
      }
    }, 200);

    // The form will continue with actual submission
    // This is just for visual feedback
  });

  // Drag and drop functionality
  const dropArea = fileInput.parentElement;
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
  });

  function highlight() {
    dropArea.classList.add('border-blue-500', 'bg-blue-50');
  }

  function unhighlight() {
    dropArea.classList.remove('border-blue-500', 'bg-blue-50');
  }

  dropArea.addEventListener('drop', handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    fileInput.files = files;
    
    // Trigger change event
    const event = new Event('change', { bubbles: true });
    fileInput.dispatchEvent(event);
  }
});
</script>
<!-- 
<style>
/* Mobile optimizations */
@media (max-width: 640px) {
  .p-6 {
    padding: 1rem;
  }
  
  .p-8 {
    padding: 1.5rem;
  }
  
  .grid-cols-1 {
    grid-template-columns: 1fr;
  }
  
  .max-w-\[200px\] {
    max-width: 150px;
  }
}

/* Improve touch targets for mobile */
button, a {
  touch-action: manipulation;
}

/* Ensure form elements are easy to tap on mobile */
input[type="file"] {
  min-height: 44px;
}

/* Better visual feedback */
.border-dashed:hover {
  border-color: #3b82f6;
  background-color: #f8fafc;
}

/* Loading spinner animation */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Progress bar transition */
#progressBar {
  transition: width 0.3s ease;
}

/* Disabled button styling */
button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
</style> -->
{% endblock %}